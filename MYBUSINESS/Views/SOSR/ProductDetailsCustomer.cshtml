@using MYBUSINESS.Models
@model List<CustomerDetailsViewModel>
@{
    Layout = null;
}
<style>
    #productDetailsTable td {
        padding: 10px; /* Adjust the value as needed */
    }

    .overall-total {
        background-color: #585555;
        color: white;
        font-weight: bold;
        text-align: right;
    }

    .change-due {
        background-color: lightgreen;
        font-weight: bold;
        text-align: right;
        float: left;
    }
</style>
<!-- jQuery 3 -->
<script src="~/bower_components/jquery/dist/jquery.min.js"></script>
<!--Global scripts-->
@*<script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="//code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <script src="~/Content/custom/downloads/jquery.mcautocomplete.js"></script>
    <script src="~/Content/custom/downloads/jquery.scannerdetection.js"></script>*@
<link href="~/Content/custom/media800.css" rel="stylesheet" />
<script src="~/Scripts/jquery.signalR-2.4.3.js"></script>
<script src="~/signalr/hubs"></script>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4 med-800">
            @*<h1>Selected Products</h1>*@
            <img src="~/dist/img/PhevaImg.png" alt="Selected Products" style="max-width: 100%; height: auto;" />
            <table class="pdetailstablemed" id="productDetailsTable">
                <thead>
                    <tr>
                        @*<th>Product ID</th>*@
                        @*<th>Product Name</th>*@
                        @*<th>Sale Price</th>*@
                        @*<th>Purchase Price</th>*@
                        @*<th>Quantity</th>*@
                        @*<th>Total</th>*@
                    </tr>
                </thead>
                <tbody>
                    <!-- This tbody will be dynamically populated -->
                </tbody>
            </table>
            <div class="paymentdetailsmed" id="paymentDetails">

            </div>
            <br />
            <br />
            <div class="customerdetailsmed" id="customerDetails">

            </div>
        </div>
        <div class="col-md-1"></div>
    </div>
</div>

<script src="~/Scripts/jquery.signalR-2.4.3.js"></script>
<script src="~/signalr/hubs"></script>
<script>
    $(document).ready(function () {
        const connection = $.connection.phevaHub;
        connection.client.broadcastProductUpdate = function (products) {
            console.log('Received product update in Detail view:', products);
            $('#productDetailsTable tbody').empty();
            let overallTotal = 0;
            products.forEach(function (product) {
                const totalPrice = product.SalePrice * product.Quantity;
                overallTotal += totalPrice;
                $('#productDetailsTable tbody').append(
                    `<tr>
                        <td style="width: 34%;">${product.ProductName}</td>
                        <td>${product.Quantity} x</td>
                       <td>${formatNumberWithDotss(totalPrice)}</td>
                    </tr>`
                );
            });
            // Append the overall total row
            if (overallTotal !== 0) {
                $('#productDetailsTable tbody').append(
                    `<tr>
                <td colspan="1"></td>
                <td class="overall-total" style="font-weight: bold;text-align: center;">${formatNumberWithDotss(overallTotal)} ₫</td> <!-- Display overall total -->
            </tr>`
                );
            }
        };
        // Payment details handler
        connection.client.broadcastPaymentDetails = function (payments) {
            console.log('Received payment details in Detail view:', payments);

            // Ensure `payments.LeftToPayVndBalance` is valid; set to 0 if NaN
            const leftToPay = isNaN(payments.LeftToPayVndBalance) ? 0 : payments.LeftToPayVndBalance;

            // Clear previous payment details if present
            $('#paymentDetails').empty();

            // Append payment details below the table
            $('#paymentDetails').append(
                `<div>
            <p><strong>Credit Card:</strong> ${payments.CardVndAmount} VND</p>
            <p class="change-due"><strong>Change due:</strong> ${leftToPay} VND</p>
        </div>`
            );
        };
        // Customer details handler
        connection.client.broadcastCustomerDetails = function (customers) {
            console.log('Received customers details in Detail view:', customers);

            // Ensure `payments.LeftToPayVndBalance` is valid; set to 0 if NaN
            // Clear previous payment details if present
            $('#customerDetails').empty();
            //CompanyName
            //:
            //"M-INVOICE - KIỂM THỬ HĐĐT CÓ MÃ"
            //CustomerAddress
            //:
            //"Số nhà 16, ngõ 269/1, đường Giáp Bát, Phường Giáp Bát, Quận Hoàng Mai, Hà Nội"
            //CustomerName
            //:
            //"Người mua không lấy hóa đơn"
            //VatNumber
            //:
            //"0106026495-999"
            // Append payment details below the table
            $('#customerDetails').append(
                `<div>
            <p><strong>Your VAT Invoice information:</strong></p>
            <p><strong>Customer name:</strong> ${customers.CustomerName}</p>
            <p><strong>Company:</strong> ${customers.CompanyName}</p>
            <p><strong>Address:</strong> ${customers.CustomerAddress}</p>
            <p><strong>Tax code:</strong> ${customers.VatNumber}</p>
        </div>`
            );
            setTimeout(function () {
                clearAllData();
            }, 15000);
        };
        //////Payment Details
        //connection.client.broadcastPaymentDetails = function (payments) {
        //    debugger;
        //    console.log('Received payment details in Detail view:', payments);
        //    $('#paymentDetails').empty(); // assuming you have an element to show payment details
        //    debugger;
        //    $('#paymentDetails').append(
        //        `<div>
        //    Card VND Amount: ${formatNumberWithDotss(payments.CardVndAmount)}<br />
        //    Left to Pay VND Balance: ${formatNumberWithDotss(payments.LeftToPayVndBalance)}
        //    </div>`
        //    );
        //};

        ///Start connection
        $.connection.hub.start({ transport: ['webSockets', 'longPolling', 'serverSentEvents'] })
            .done(function () {
                console.log('Connection started!');
            })
            .fail(function (error) {
                console.error('Could not connect to SignalR hub:', error);
            });

        function formatNumberWithDotss(number) {
            var numberStr = Math.floor(number).toString();
            return numberStr.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        function clearAllData() {
            $('#productDetailsTable tbody').empty(); // Clear product details
            $('#paymentDetails').empty(); // Clear payment details
            $('#customerDetails').empty(); // Clear customer details
        }
    });

</script>

@*<td>${product.ProductId}</td>
    <td>${product.ProductName}</td>
    <td>${product.SalePrice}</td>
    <td>${product.PurchasePrice}</td>
    <td>${product.Quantity}</td>*@
@*<td colspan="2" style="text-align: right; font-weight: bold;">Overall Total:</td>*@