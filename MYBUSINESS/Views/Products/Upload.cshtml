
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="col-md-12 mt-2">
    <div class="card card-success">
        <div class="card-header">
            <h3 class="card-title">Upload Products excel file</h3>
        </div>
        <div class="card-body">


            <div class="contentData">


                <div class="row mt-5">
                    <label for="ExcelSheetUploadHeading" class="col-sm-6 col-form-label">Choose Excel file and click on upload button</label>
                </div>

                <div class="form-group row mt-3">
                    @*<label for="ExcelFile" class="col-sm-2 col-form-label">Select Excel File:</label>*@
                    <div class="col-sm-4">
                        @*<input type="file" accept=".xlsx" id="excelFile" class="form-control-file" name="name" value="" />*@
                        <input type="file" accept=".xlsx" id="upload" class="form-control-file" name="files[]" value="" />
                    </div>
                    <div class="col-sm-3">
                        <button id="btnUpload" class="btn btn-success btn-block btn-sm">Upload</button>

                        @*<input id="upload" type=file name="files[]">*@

                        @*<textarea class="form-control" rows=35 cols=120 id="xlx_json"></textarea>*@
                    <div id="wait" style="display:none;">
                        <div>it will take aprox. <label class="countdown"></label> minute(s)</div>
                        <div><img src='~/Images/Ripple_1s_200px_Transparent.gif' width="38" height="38" /></div>
                    </div>
                        
                    </div>

                </div>
                <div id="fileUploadSection" class="col-sm-12 text-center"></div>

                <div class="row">
                    <table id="importedTable" class="table table-striped table-hover">
                        <thead style="background-color: #007bff; color: white;">

                        </thead>
                        <tbody>
                        </tbody>
                    </table>


                </div>

            </div>


        </div>

    </div>
</div>


@*<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>*@


<!-- DataTables -->
<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">



<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>*@


<script>

    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    $("#productsLink").css("display", "none");


    document.getElementById('upload').addEventListener('change', handleFileSelect, false);
    var xlRowsLength = 0;

    var ExcelToJSON = function () {

        this.parseExcel = function (file) {
            var reader = new FileReader();

            reader.onload = function (e) {
                var data = e.target.result;
                var workbook = XLSX.read(data, {
                    type: 'binary'
                });

                workbook.SheetNames.forEach(function (sheetName) {
                    // Here is your object
                    var XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                    xlRowsLength = (XL_row_object.length / 60) + (XL_row_object.length / 120);
                    //xlRowsLength = xlRowsLength + xlRowsLength / 2;
                    //alert(Math.ceil(xlRowsLength));
                    //$('#wait').text("it will take almost" Math.ceil(xlRowsLength) "minute(s)");
                    //var json_object = JSON.stringify(XL_row_object);
                    //console.log(JSON.parse(json_object));
                    //jQuery('#xlx_json').val(json_object);

                })

            };

            reader.onerror = function (ex) {
                console.log(ex);
            };

            reader.readAsBinaryString(file);
        };


    };

    function handleFileSelect(evt) {

        var files = evt.target.files; // FileList object
        var xl2json = new ExcelToJSON();
        xl2json.parseExcel(files[0]);
    }

    $("#btnUpload").click(function () {

        //------------------
        
        var timer2 = Math.ceil(xlRowsLength) + ":00";//"5:01";

        var interval = setInterval(function () {


            var timer = timer2.split(':');
            //by parsing integer, I avoid all extra string processing
            var minutes = parseInt(timer[0], 10);
            var seconds = parseInt(timer[1], 10);
            --seconds;
            minutes = (seconds < 0) ? --minutes : minutes;
            if (minutes < 0) clearInterval(interval);
            seconds = (seconds < 0) ? 59 : seconds;
            seconds = (seconds < 10) ? '0' + seconds : seconds;
            //minutes = (minutes < 10) ?  minutes : minutes;
            $('.countdown').html(minutes + ':' + seconds);
            timer2 = minutes + ':' + seconds;
        }, 1000);
        //------------------------

        

        $(document).ajaxStart(function () {
            $("#wait").css("display", "block");

        });
        $(document).ajaxComplete(function () {
            $("#wait").css("display", "none");

        });



        if ($("#upload")[0].files.length > 0) {


            if (window.FormData !== undefined) {
                var fileUpload = $("#upload").get(0);
                var files = fileUpload.files;
                var fileData = new FormData();

                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);


                    //const table = XLSX.readFile('G:/PROJECTS BACKUP/BMS Zahra Rubab New - hans - Upgraded (current)/MYBUSINESS/Uploads/Products To Upload - Template - Hans Corp Abwabal (1).xlsx');
                    //alert(files[i].name);
                    //const sheet = table.Sheets[table.SheetNames[0]];
                    //var range = XLSX.utils.decode_range(sheet['!ref']);
                    //console.log(range.e.r);
                }

                fileData.append('tableName', $("#formName").val());

                $.ajax({
                    url: '/Products/UploadExcelFile',
                    type: "POST",
                    contentType: false, // Not to set any content header
                    processData: false, // Not to process data
                    data: fileData,
                    success: function (result) {

                        if (result.allErrors.length > 0) {
                            var errorMsg = '';
                            for (var err = 0; err < result.allErrors.length; err++) {
                                errorMsg += result.allErrors[err] + ' , ';
                            }
                            $("#upload").val('');
                            $("#fileUploadSection").html('');
                            return alert(errorMsg);
                        }
                        //else if (result.allRows.length == 0) {
                        //  $("#excelFile").val('');
                        //  $("#fileUploadSection").html('');
                        //  return alert("Please add some data in excel.");
                        //}
                        else {
                            //$("#importedTable thead").html('');
                            //for (var col = 0; col < result.allColumns.length; col++) {
                            //  $("#importedTable thead").append('<th scope="col">' + result.allColumns[col] + '</th>');
                            //}
                            //var colNo = 0;
                            //for (var rows = 0; rows < (result.noOfRows - 1); rows++) {
                            //  $("#importedTable tbody").append('<tr>');

                            //  for (var row = 0; row < result.allColumns.length; row++) {
                            //    $("#importedTable tbody").append('<td>' + result.allRows[colNo] + '</td>');
                            //    ++colNo;
                            //  }
                            //  $("#importedTable tbody").append('</tr>');
                            //}
                            $("#upload").val('');
                            $("#fileUploadSection").html('');
                            //$("#fileUploadSection").append('<label for="ExcelFile" class="col-sm-6 col-form-label text-center">Excel File Uploaded Successfully!</label>');
                            $("#fileUploadSection").append('<a class="btn btn-info col-sm-6" href="/Products/Index" id="productsLink">Excel File Uploaded Successfully! <b>Back to Products</b></a>');
                            //$("#fileUploadSection").append('');

                        }


                    },
                    error: function (err) {
                        console.log(err.statusText);
                    }
                });
            } else {
                alert("FormData is not supported.");
            }
        } else {
            alert("Please Upload Excel File.");
        }
    });


</script>

